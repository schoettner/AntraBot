language: python
python: 3.5
services:
  - docker
install:
  - pip install -r requirements.txt
script:
  - PYTHONPATH=./ pytest -s # run unit tests
  - docker build -t antra-bot . # build docker container

jobs:
  include:
    - stage: "install requirements"
      script: pip install -r requirements.txt
    - stage: "unit tests"
      script: PYTHONPATH=./ pytest -s
#    - stage: "build container"
#      script: docker build -t registry.heroku.com/antra-bot .
#    - stage: "deploy container"
#      script:
#        - docker login -u _ -p "$HEROKU_AUTH_TOKEN"  registry.heroku.com
#        - docker push registry.heroku.com/antra-bot
#    - stage: "start container"
#      script: heroku run --app antra-bot -e TWITCH_USERNAME=$TWITCH_USERNAME -e CLIENT_ID=$CLIENT_ID -e TWITCH_TOKEN=$TWITCH_TOKEN -e CHANNEL=$CHANNEL
    - stage: "deploy container"
      deploy:
        provider: heroku
        app: antrabot
        api_key: $HEROKU_AUTH_TOKEN
        run: python3 ./antra_bot.py $TWITCH_USERNAME $CLIENT_ID $TWITCH_TOKEN $CHANNEL
#        run: docker run -e TWITCH_USERNAME=$TWITCH_USERNAME -e CLIENT_ID=$CLIENT_ID -e TWITCH_TOKEN=$TWITCH_TOKEN -e CHANNEL=$CHANNEL antra-bot
#        on:
#          branch: master
#notifications:
#  slack:
#    on_success: change
#    on_failure: always